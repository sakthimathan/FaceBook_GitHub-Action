name: CI - Selenium Tests with Extent Report (Ubuntu Runner)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Runs every Sunday at midnight

jobs:
  selenium-tests:
    runs-on: [self-hosted, X64, Linux]   # ✔ EXACT Runner Labels

    env:
      DISPLAY: ":99"                     # ✔ Global DISPLAY for Selenium + ffmpeg

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Verify Environment
        run: |
          java -version
          mvn -version
          which ffmpeg
          which Xvfb
          echo "DISPLAY=$DISPLAY"

      # ----------------------------------------------------
      # Start Xvfb Virtual Display
      # ----------------------------------------------------
      - name: Start Xvfb Server
        run: |
          echo "Starting Xvfb on :99"
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 3
          echo "Xvfb running on DISPLAY=$DISPLAY"

      # ----------------------------------------------------
      # Start Screen Recording (FFmpeg)
      # ----------------------------------------------------
      - name: Start Screen Recording
        run: |
          mkdir -p recordings
          echo "Starting screen recording..."
          ffmpeg -y \
            -f x11grab \
            -draw_mouse 1 \
            -video_size 1920x1080 \
            -i $DISPLAY \
            -r 24 \
            recordings/test-run.mp4 > ffmpeg.log 2>&1 &
          echo "FFmpeg Started."

      - name: Build with Maven
        run: mvn clean compile

      # ----------------------------------------------------
      # Run Selenium Tests (GUI Visible)
      # ----------------------------------------------------
      - name: Run Selenium Tests
        env:
          DISPLAY: ":99"
        run: |
